version: "3.8"

services:
  photo-restoration:
    build:
      context: .
      dockerfile: Dockerfile
    image: photo-restoration:latest
    container_name: photo-restoration

    # GPU passthrough - альтернативный способ через runtime
    runtime: nvidia

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

      # === Режим обработки ===
      # normal    - без царапин
      # scratch   - с удалением царапин
      # scratch_hr - высокое разрешение + царапины
      - PROCESSING_MODE=scratch
      - GPU_ID=0
      # Макс. размер изображения (пикселей). Большие будут уменьшены для экономии GPU памяти
      - MAX_IMAGE_SIZE=2048

      # === Архивация ===
      - ARCHIVE_ENABLED=true
      - ARCHIVE_FORMAT=zip

    # === VOLUMES ===
    # Модели + input/output через SMB-шару
    volumes:
      - /mnt/proxmox/models:/data/models
      - /mnt/proxmox/photo_restoration/input:/data/input
      - /mnt/proxmox/photo_restoration/output:/data/output

    restart: "no"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# ИНСТРУКЦИЯ ДЛЯ DOKPLOY:
# =============================================================================
#
# 1. На Proxmox в папке /srv/proxmox/models должны лежать:
#    - face_checkpoints.zip
#    - global_checkpoints.zip
#    - shape_predictor_68_face_landmarks.dat
#
# 2. На VM примонтируй общую папку (если ещё не сделано):
#    mount -t cifs //192.168.2.100/proxmox /mnt/proxmox -o guest
#
# 3. В Dokploy создай Docker Compose сервис с этим файлом
#
# 4. Включи GPU в настройках сервиса Dokploy
#
# 5. Кладёшь фото в \\192.168.2.100\proxmox\photo_restoration\input
#    Забираешь результаты из \\192.168.2.100\proxmox\photo_restoration\output
